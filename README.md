# socket-programming

- C言語でソケットプログラミングを行う
- サーバーはクライアントからデータを受け取ったら何かしらのデータをクライアントに返す
- クライアント・サーバー間はTCPで通信する
- 使うシステムコールはsocket, bind, listen, accept, read, writeなど
- エラーが起きた時の処理は必ず書くこと
- GitHubにコミット（PRとか）
- 余裕があれば
  - スレッドを使ってデータのやり取りが多くなるように高速化を行う
  - サーバーが特定のシグナルを受け取ったら停止するようにする

## 改行コード

下記のようにOSによって改行コードは異なるが、C言語の標準ライブラリではファイルを開くときにテキストモードとバイナリモードを指定することができ、テキストモードの場合は改行コードを`\n`に自動的に置換するのに対し、バイナリモードの場合はファイルの内容を一切変更せずにそのまま読み書きする。例えば`FILE *file = fopen("example.txt", "r");`とするとテキストモードでファイルを開き、`FILE *file = fopen("example.txt", "rb");`とするとバイナリモードでファイルを開く。標準入出力の場合はテキストモードしか使用することができない。そのため、`scanf`や`printf`を使うときは、テキストモードになる。

| OS | 名称 | エスケープ表記 |
| --- | --- | --- |
| Windows | CRLF | `\r\n` |
| Unix (Linux, macOS, FreeBSD) | LF | `\n` |
| 昔のMac | CR | `\r` |

## `scanf`

ユーザーが標準入力すると、入力バッファにデータが一旦格納される。`scanf`はこの入力バッファからデータを読み取り、変数に格納する。`scanf`は特に指定がなければ、入力バッファからデータを全て読み取るため、格納先の変数の容量以上のデータを入力すると、バッファオーバーフローが発生する。それを避けるためには、フォーマット指定子に最大文字数を指定する必要がある。例えば、`input[100]`としたとき、終端文字を除いて最大99文字まで読み取る場合は、`scanf("%99s", input);`とする。

`scanf`でよく使われる`%s`や`%d`というフォーマット指定子は、空白文字（空白、タブ、改行など）を区切りとしてデータを読み取る。なので例えばユーザーが`Alice 25`と入力した場合、`scanf("%s %d", name, &age);`で読み取ると、`name`には1が、`age`には25が格納される。そのため、例えば`%[^\n]`のようにして正規表現のように指定することで、空白文字を区切りとせずにデータを読み取ることができる。`%[^\n]`は改行文字以外の全ての文字を読み取るという意味である。そのため、例えば`Hello World\n`と入力すると、空白文字を含む`Hello World`が変数に格納される。

ユーザーは標準入力の最後にエンターキーを押すため、改行文字も入力バッファに入るが、`scanf`でよく使われる`%s`や`%d`というフォーマット指定子は、前述したように空白文字を区切りとしてデータを読み取るため、改行文字は読みとられず、入力バッファに残ることになり、予期せぬ動作を引き起こすことがある。そのため、`scanf`の後に入力バッファに残っている改行文字を`getchar`で読み取り、捨てることが一般的である。

下記は`%c`を使って1文字だけ読み取る例である。`%c`は空白文字も読み取るため、改行文字を読み取ることができる。そのため、`a\n`と入力すると、最初に`a`が表示され、次に入力バッファに残っている改行文字が表示される。

```c
int main() {
  char input;
  while (1) {
    printf("echo> ");
    scanf("%c", &input);
    printf("%c\n", input);
  }
}
```

```sh
echo> a
a
echo> 

echo> 
```

[[迷信] scanfではバッファオーバーランを防げない](https://www.kijineko.co.jp/迷信-scanfではバッファオーバーランを防げない/)

[C言語の標準入力関数をまとめてみた　～①scanf,getchar,gets～](https://ameblo.jp/koshi-8-ginchaku/entry-12252499746.html)
